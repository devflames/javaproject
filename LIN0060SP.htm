<!DOCTYPE html>
<!--
* CoreUI Pro based Bootstrap Admin Template
* @version v3.2.0
* @link https://coreui.io/pro/
* Copyright (c) 2020 creativeLabs ?ukasz Holeczek
* License (https://coreui.io/pro/license)
-->
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="description" content="CoreUI - Open Source Bootstrap Admin Template">
    <meta name="author" content="?ukasz Holeczek">
    <meta name="keyword" content="Bootstrap,Admin,Template,Open,Source,jQuery,CSS,HTML,RWD,Dashboard">
    <title>オートビズ管理画面</title>
    <!-- Main styles for this application-->
	#parse( "include/style.inc")
  </head>

  <body class="c-app">
	#parse( "include/sidebar.inc")
    <div class="c-wrapper">
	#parse( "include/global_header.inc")
      <div class="c-body">
        <main class="c-main">
          <div class="container-fluid">
            <div class="fade-in">
              <h1 class="h4 d-flex align-items-center mb-3">
                <a href="php2java.php?file=LIN0000&if=3"><button class="btn-back"></button></a>
                タグ管理
              </h1>
              <small>フォルダとタグは最大20個まで設定できます</small>
              <div class="mb-2 ml-auto" id="FOLDER_HEADER">
                <button class="btn btn-sm btn-primary" id="addFolderButton">
                  ＋ 新しいフォルダ
                </button>
              </div>

              <div class="accordion" id="accordion" role="tablist">

              #foreach( $!{folder} in $!{FOLDER_LIST})
                #if( $!{folder.folder_id} != $former_id )
                <div class="card mb-0">
                  <div class="card-header bg-light d-flex align-items-center" role="tab" data-id="$!{folder.folder_id}">
                    <div class="editLabelSwitcher">
                      <div class="editLabelSwitcher__label">
                        <a data-toggle="collapse" href="#collapse$!{folder.folder_id}" role="button" aria-expanded="false" aria-controls="collapse$!{folder.folder_id}">
                          $!{folder.folder_name}
                        </a>
                      </div>

                      <form method="POST" class="editLabelSwitcher__form" id="FORM$!{folder.folder_id}" action="php2java.php?file=LIN0060&if=3">
                      <div class="editLabelSwitcher__form">
                        <div class="input-group input-group-sm">
                          <input type="text" name="FOLDER_NAME" maxlength="15" class="form-control" value="$!{folder.folder_name}">
                          <div class="input-group-append">
                            <button type="submit"class="btn btn-secondary">決定</button>
                          </div>
                        </div>
                      </div>
                      <input type="hidden" name="EXEC_TYPE" id="EXEC_TYPE$!{folder.folder_id}" value="FOLDER_EDIT">
                      <input type="hidden" name="FOLDER_ID" id="FOLDER_ID" value="$!{folder.folder_id}">
                      <input type="hidden" name="SORT_NO" id="SORT_NO" value="$!{folder.folder_sort_no}">
                      </form>

                      <div class="editLabelSwitcher__icon">
                        <i class="cil-color-border"></i>
                      </div>
                    </div>
                    <i class="cil-trash ml-auto" data-id ="$!{folder.folder_id}" data-type="FOLDER_DEL"></i>
                  </div>

                  <div class="collapse" id="collapse$!{folder.folder_id}" role="tabpanel" data-parent="#accordion">
                    <div class="card-body">
                      <div class="mb-2" id="TAG_HEADER$!{folder.folder_id}">
                        <button class="btn btn-sm btn-primary addTagButton"  data-id="$!{folder.folder_id}">
                          ＋ 新しいタグ
                        </button>
                      </div>
                      <div class="table-scroll-sm">
                        <table class="table table-hover table-bordered mb-0" id="tagTable$!{folder.folder_id}" >
                          <thead class="thead-light">
                            <tr>
                              <th>タグ名</th>
                              <th>フォルダ</th>
                              <th>作成日</th>
                              <th></th>
                            </tr>
                          </thead>
                          <tbody id="TAG_LIST$!{folder.folder_id}">
                          #foreach( $!{tag} in $!{FOLDER_LIST})
                            #if( $!{tag.tag_id} > 0 )
                           	 <tr class="TAG_$!{tag.folder_id}">
                              <td>
                                <div class="editLabelSwitcher">
                                  <div class="editLabelSwitcher__label">
                                    $!{tag.tag_name}
                                  </div>
                                  <!--  <div class="editLabelSwitcher__form"> -->
                                  <form method="POST" class="editLabelSwitcher__form" id="FORM$!{tag.tag_id}" action="php2java.php?file=LIN0060&if=3">
                                    <div class="input-group input-group-sm">
                                      <input type="text" name="TAG_NAME" maxlength="15" class="form-control" value="$!{tag.tag_name}">
                                      <div class="input-group-append">
                                        <button class="btn btn-secondary">決定</button>
                                      </div>
                                    </div>
                                  	<input type="hidden" name="EXEC_TYPE" id="EXEC_TYPE$!{tag.tag_id}" value="TAG_EDIT">
		                            <input type="hidden" name="TAG_ID" id="TAG_ID" value="$!{tag.tag_id}">
		                            <input type="hidden" name="FOLDER_ID" value="$!{tag.folder_id}">
		                            <input type="hidden" name="SORT_NO" id="SORT_NO" value="$!{tag.tag_sort_no}">
                                  </form>
                                  <!-- </div> -->
                                  <div class="editLabelSwitcher__icon">
                                    <i class="cil-color-border" data-id ="$!{tag.tag_id}" data-type="TAG_DEL"></i>
                                  </div>
                                </div>
                              </td>
                              <td>
                                $!{tag.folder_name}
                              </td>
                              <td>
                               $format.date($tag.create_date, "yyyy/MM/dd HH:mm")
                              </td>
                              <td>
                                <a href="javascript:void(0);" class="trash" data-id ="$!{tag.tag_id}" data-type="TAG_DEL">
                                  <button type="button" class="btn btn-pill btn-sm btn-light">
                                    <i class="cil-trash"></i> 削除
                                  </button>
                                </a>
                              </td>
                            </tr>
                            #end
                           #end

		                  <form method="POST" id="SORT_FORM" action="php2java.php?file=LIN0060&if=3">
		                  <input type="hidden" name="EXEC_TYPE" value="">
		                  <input type="hidden" name="SORT_NO_STR" value="">
		                  <input type="hidden" name="FOLDER_ID_STR" value="">
		                  <input type="hidden" name="TAG_ID_STR" value="">
		                  </form>

                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>


                </div>
                  #end
                  #set( $former_id = $!{folder.folder_id})
                #end

              </div>
            </div>
          </div>
        </main>
      </div>
		#parse( "include/c_footer.inc")
    </div>
    <!-- CoreUI and necessary plugins-->
	#parse( "include/js.inc")
	<script type="text/javascript">
		$(document).ready(function(){

			// フォルダ選択
			$(".card-header").on("click",function(){
				var folder_id = $(this).data("id");
				$("#TAG_LIST"+folder_id+" tr").hide();
				$(".TAG_"+folder_id).show();

				// 20個以上なら
				if( $("#TAG_LIST"+folder_id+" tr:visible").length >= 20 ){
					$("#TAG_HEADER"+folder_id).hide();
				}

			});

			// フォルダ数制限
			if( $(".card").length > 20 ){

				$("#FOLDER_HEADER").hide();

			}

			var Trash = function(){
				$('.cil-trash,.trash').on('click', function (e) {
					 var type = $(this).data("type");
					 var id = $(this).data("id");

					 var form_name = "FORM"+id;

					 $("#EXEC_TYPE"+id).val(type);
					 $("#"+form_name).submit();
				})
			}

			// 名前変更
			var EditLabelSwitcher = function () {
				  if ($('.editLabelSwitcher').length > 0) {
				    var target = $('.editLabelSwitcher');
				    target.each(function (index, element) {
				      var icon = $(this).find('.editLabelSwitcher__icon');
				      var label = $(this).find('.editLabelSwitcher__label');
				      var form = $(this).find('.editLabelSwitcher__form');
				      var button = $(this).find('.editLabelSwitcher__form button');
				      icon.on('click', function (e) {
				        e.stopPropagation();
				        e.preventDefault();
				        label.hide();
				        icon.hide();
				        form.show();
				        return false;
				      })
				      button.on('click', function (e) {
				        e.stopPropagation();
				        e.preventDefault();
				        label.show();
				        icon.show();
				        form.submit();
				        form.hide();
				      })
				    })
				  }
			}

			//タグ編集
			var TagsListEdit = function () {
			  //新規フォルダ追加処理
			  $('#addFolderButton').on('click', function (e) {

			    var addFolderItem = `
			                    <li class="list-group-item active list-group-item-action d-flex align-items-center">
			                      <i class="h5 cil-folder mr-2"></i>
			                      <div class="editLabelSwitcher mode-edit">
			                        <div class="editLabelSwitcher__label">
			                          新しいフォルダ
			                        </div>
			                        <form method="POST" class="editLabelSwitcher__form" action="php2java.php?file=LIN0060&if=3">
			                          <div class="input-group input-group-sm">
			                            <input type="text" name="FOLDER_NAME" maxlength="15" class="form-control" value="" placeholder="新しいフォルダ名">
			                            <div class="input-group-append">
			                              <button class="btn btn-secondary">決定</button>
			                            </div>
			                          </div>
			                          <input type="hidden" name="EXEC_TYPE" value="FOLDER_ADD">
			                        </form>
			                        <div class="editLabelSwitcher__icon">
			                          <i class="cil-color-border"></i>
			                        </div>
			                      </div>
			                      <i class="cil-trash ml-auto" ></i>
			                    </li>`;

			    $('#accordion').prepend(addFolderItem).find('input').focus();
			    $('#accordion div').not(':first').find('.mode-edit').removeClass('mode-edit');
			    EditLabelSwitcher();

			    if( $("#accordion div").lengh == 20 ){
			    	$("#addFolderButton").hide();
			    }
			  });

			  //新規タグ追加処理
			  $('.addTagButton').on('click', function () {

				var folder_id = $(this).data("id");
				var folder_name = $("#FORM"+folder_id+" input[name='FOLDER_NAME']").val();

			    var addTagItem = `
			                    <tr>
			                      <td>
			                        <div class="editLabelSwitcher mode-edit">
			                          <div class="editLabelSwitcher__label">
			                            新しいタグ
			                          </div>
			                            <form method="POST" class="editLabelSwitcher__form" action="php2java.php?file=LIN0060&if=3">
			                            <div class="input-group input-group-sm">
			                              <input type="text" name="TAG_NAME" maxlength="15" class="form-control" value="" placeholder="新しいタグ名">
			                              <div class="input-group-append">
			                                <button class="btn btn-secondary">決定</button>
			                              </div>
			                              <input type="hidden" name="EXEC_TYPE" value="TAG_ADD">
			                              <input type="hidden" name="FOLDER_ID" value="` + folder_id + `">
			                            </form>
			                          </div>
			                          <div class="editLabelSwitcher__icon">
			                            <i class="cil-color-border"></i>
			                          </div>
			                        </div>
			                      </td>
			                      <td>
			                        ` + folder_name +`
			                      </td>
			                      <td>
			                        -
			                      </td>
			                      <td>

			                      </td>
			                    </tr>`;

			    $("#tagTable"+folder_id+" tbody").prepend(addTagItem).find('input').focus();
			    $('#TAG_LIST'+folder_id+' tr').not(':first').find('.mode-edit').removeClass('mode-edit');

			    EditLabelSwitcher();
			  });
			}

			EditLabelSwitcher();
			TagsListEdit();
			Trash();
		});
	</script>


  </body>
</html>